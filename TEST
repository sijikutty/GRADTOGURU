from playwright.sync_api import Page
from automation_utils import get_testdata
from ps_utils import navigate_menu
import pytest 
import time
from Common_function import jrnl_edit

@pytest.mark.parametrize("testcase", get_testdata("test_open_period_update"))
def test_open_period_update(page:Page,  testcase):

    testdata = testcase["testdata"]

    navigate_menu(page=page,
                  menu_sequence=["Set Up Financials/Supply Chain", 
                                 "Business Unit Related", 
                                 "General Ledger", 
                                 "Open Periods",
                                 "Open Periods Mass Update"])
    
    targetContentFrame = page.frame_locator("iframe[name=\"TargetContent\"]")

    targetContentFrame.get_by_label("Calendar").fill(testdata['Calendar'])
    targetContentFrame.get_by_label("Unit").fill(testdata['Unit'])
    targetContentFrame.get_by_label("Ledger Code").fill(testdata['Ledger_Code'])
    targetContentFrame.get_by_label("Ledger Group").fill(testdata['Ledger_Group'])
    targetContentFrame.get_by_role("button", name="Search").click()
    targetContentFrame.get_by_label("From Period").fill(testdata['From_Period1'])
    targetContentFrame.get_by_label("To Period").fill(testdata['To_Period1'])
    targetContentFrame.locator("[id=\"OPEN_CLOSE_WRK_SELECT_FLAG\\$0\"]").check()
    targetContentFrame.locator("[id=\"OPEN_CLOSE_WRK_SELECT_FLAG\\$1\"]").check()
    targetContentFrame.get_by_role("button", name="Apply").click()


    From_period=targetContentFrame.locator("[id=\"FIN_OPEN_PERIOD_OPEN_PERIOD_FROM\\$0\"]")
    To_period=targetContentFrame.locator("[id=\"FIN_OPEN_PERIOD_OPEN_PERIOD_TO\\$0\"]")

    if From_period.inner_text()==testdata['From_Period1'] and To_period.inner_text()==testdata['To_Period1']:
        print("Mass update success")
    else:
        raise Exception(f"Mass update failed")

    targetContentFrame.get_by_label("From Period").fill(testdata['From_Period2'])
    targetContentFrame.get_by_label("To Period").fill(testdata['To_Period2'])
    targetContentFrame.locator("[id=\"OPEN_CLOSE_WRK_SELECT_FLAG\\$0\"]").check()
    targetContentFrame.locator("[id=\"OPEN_CLOSE_WRK_SELECT_FLAG\\$1\"]").check()
    targetContentFrame.get_by_role("button", name="Apply").click()

    if From_period.inner_text()==testdata['From_Period2'] and To_period.inner_text()==testdata['To_Period2']:
        print("Mass update success")
    else:
        raise Exception(f"Mass update failed")
