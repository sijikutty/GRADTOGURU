import os
import time
import json
import pandas as pd
import pytest
import psutil
import win32com.client
from playwright.sync_api import Page
from automation_utils import get_testdata, construct_ps_fah_credentials, save_credentials
from ps_utils import navigate_menu, add_run_control_id, schedule_process, monitor_process

# Helper function to fill a form field
def fill_form_field(frame, label, value, exact=False):
    frame.get_by_label(label, exact=exact).fill(value)

# Helper function to click a button
def click_button(frame, name, exact=False):
    frame.get_by_role("button", name=name, exact=exact).click()

# Helper function to click a link
def click_link(frame, name):
    frame.get_by_role("link", name=name).click()

# Function to navigate and perform actions on the "Define ChartField Value" section
def define_chartfield_value(page: Page, testdata):
    navigate_menu(page=page, menu_sequence=[
        "Set Up Financials/Supply Chain", 
        "Common Definitions", 
        "Design ChartFields", 
        "Define Values",
        "Define ChartField Value"
    ])
    
    target_frame = page.frame_locator("iframe[name=\"TargetContent\"]")

    click_link(target_frame, testdata['Link'])
    fill_form_field(target_frame, "SetID", testdata['SETID'])
    fill_form_field(target_frame, "Account", testdata['Chartfieldvalue'], exact=True)
    click_button(target_frame, "Search", exact=True)
    target_frame.get_by_role("cell", name="Correct History", exact=True).locator("a").click()
    fill_form_field(target_frame, "Description", testdata['CFDescr'], exact=True)
    click_button(target_frame, "Save")

# Function to navigate and initiate the "Full Data Publish" process
def initiate_full_data_publish(page: Page, testdata):
    navigate_menu(page=page, menu_sequence=[
        "Enterprise Components", 
        "Integration Definitions", 
        "Initiate Processes", 
        "Full Data Publish"
    ])

    add_run_control_id(page=page, run_ctrl_id=testdata['run_control_id'])
    target_frame = page.frame_locator("iframe[name=\"TargetContent\"]")
    
    fill_form_field(target_frame, "Request ID", testdata['Request_id'])
    fill_form_field(target_frame, "Description", testdata['Request_descr'])
    target_frame.get_by_label("Once").check()
    fill_form_field(target_frame, "Service Operation", testdata['Operation_name'])
    click_button(target_frame, "Run")

# Function to monitor and validate the asynchronous service status
def monitor_asynchronous_service(page: Page, testdata):
    navigate_menu(page=page, menu_sequence=[
        "PeopleTools", 
        "Integration Broker", 
        "Service Operations Monitor", 
        "Monitoring",
        "Monitor Asynchronous Services"
    ])

    target_frame = page.frame_locator("iframe[name=\"TargetContent\"]")
    
    click_button(target_frame, "Operation Instances")
    fill_form_field(target_frame, "Service Operation", testdata['Operation_name'])
    target_frame.get_by_label("Status").select_option("")
    click_button(target_frame, "Refresh")

    retry = 0
    while retry < 200:
        status = target_frame.locator("[id=\"IB_MONITOR_AMM_STATUS\\$0\"]").inner_text()
        if status == "Done":
            return
        else:
            time.sleep(5)
            click_button(target_frame, "Refresh")
            retry += 1
    
    raise Exception("IB Status is not Done.")

# Function to handle UFT testing
def handle_uft_testing(testdata):
    if os.path.exists("Result/tcjson.xlsx"):
        os.remove("Result/tcjson.xlsx")
    if os.path.exists("Result/uftres.json"):
        os.remove("Result/uftres.json")
    
    df = pd.DataFrame([testdata])
    df.to_excel("Result/tcjson.xlsx", index=False)

    credentials_data = construct_ps_fah_credentials(testdata)
    cred_json_file_path = save_credentials(credentials_data)

    try:
        uft = win32com.client.Dispatch("QuickTest.Application")
        uft.Launch()
        uft.Visible = True
        uft.Open(testdata["test_path"])

        uftResultsOpt = win32com.client.Dispatch("QuickTest.RunResultsOptions")
        uft.Test.Save()
        uft.Test.Run(uftResultsOpt, True)

        with open("Result/uftres.json", 'r') as json_file:
            data = json.load(json_file)

        verdict = data['Rally']['verdict']
        result = data['Rally']['notes']

        if verdict != "Pass":
            if result:
                raise Exception(result)

        print("Script execution success!")

    except Exception as e:
        print("Error:", e)
        raise e

    finally:
        if os.path.exists(cred_json_file_path):
            os.remove(cred_json_file_path)
        uft.Test.Close()
        uft.Quit()

# Main test function
@pytest.mark.parametrize("testcase", get_testdata("test_Chartfield_Validation_ACCOUNT"))
def test_Chartfield_Validation_ACCOUNT(page: Page, testcase):
    testdata = testcase["testdata"]

    define_chartfield_value(page, testdata)
    initiate_full_data_publish(page, testdata)
    monitor_asynchronous_service(page, testdata)
    handle_uft_testing(testdata)
